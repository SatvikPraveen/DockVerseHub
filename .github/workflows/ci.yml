name: DockVerseHub CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  DOCKER_BUILDKIT: 1

jobs:
  validate-syntax:
    name: Validate Code Syntax
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Validate Python syntax
        run: |
          echo "Validating Python files..."
          python -m py_compile $(find . -name "*.py" -type f 2>/dev/null | grep -v __pycache__)
          echo "✓ All Python files have valid syntax"
      
      - name: Validate shell scripts
        run: |
          echo "Validating shell scripts..."
          find . -name "*.sh" -type f | while read file; do
            bash -n "$file" || exit 1
          done
          echo "✓ All shell scripts are valid"

  validate-configuration:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Validate YAML files
        run: |
          python -m pip install pyyaml > /dev/null 2>&1
          echo "Validating YAML configuration files..."
          for file in $(find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | head -20); do
            python -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done
          echo "✓ All YAML files are valid"
      
      - name: Check Makefile
        run: |
          echo "Validating Makefile..."
          [ -f Makefile ] || exit 1
          grep -q "^help:" Makefile || exit 1
          echo "✓ Makefile is valid"
      
      - name: Verify project structure
        run: |
          echo "Verifying project structure..."
          
          required_dirs=(
            "concepts"
            "labs"
            "docs"
            "utilities"
            ".github"
          )
          
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "✗ Missing required directory: $dir"
              exit 1
            fi
          done
          
          echo "✓ Project structure is valid"

  verify-labs:
    name: Verify Lab Structure
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check all labs
        run: |
          echo "Verifying lab structure..."
          
          for lab_dir in labs/lab_*; do
            if [ -d "$lab_dir" ]; then
              lab_name=$(basename "$lab_dir")
              
              # Check for README
              if [ ! -f "$lab_dir/README.md" ]; then
                echo "✗ $lab_name: Missing README.md"
                exit 1
              fi
              
              # Check for Docker files
              if [ ! -f "$lab_dir/docker-compose.yml" ] && [ ! -f "$lab_dir/Dockerfile" ]; then
                echo "✗ $lab_name: Missing docker-compose.yml or Dockerfile"
                exit 1
              fi
              
              echo "✓ $lab_name structure valid"
            fi
          done

  verify-concepts:
    name: Verify Concept Modules
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check all concepts
        run: |
          echo "Verifying concept modules..."
          
          count=0
          for concept_dir in concepts/[0-9]*; do
            if [ -d "$concept_dir" ]; then
              concept_name=$(basename "$concept_dir")
              
              if [ ! -f "$concept_dir/README.md" ]; then
                echo "✗ $concept_name: Missing README.md"
                exit 1
              fi
              
              echo "✓ $concept_name structure valid"
              count=$((count + 1))
            fi
          done
          
          echo "✓ All $count concept modules are valid"

  check-documentation:
    name: Verify Documentation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check essential documentation
        run: |
          echo "Verifying documentation files..."
          
          required_files=(
            "README.md"
            "LICENSE"
            "Makefile"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "✗ Missing required file: $file"
              exit 1
            fi
            echo "✓ $file exists"
          done
          
          # Check for docs folder content
          echo "Checking docs folder..."
          required_docs=(
            "docs/GETTING_STARTED.md"
            "docs/CONTRIBUTING.md"
          )
          
          for file in "${required_docs[@]}"; do
            if [ ! -f "$file" ]; then
              echo "⚠ $file not found (docs are organized in docs/ folder)"
            else
              echo "✓ $file exists"
            fi
          done
          
          # Check that docs directory has content
          if [ -d "docs" ]; then
            doc_count=$(find docs -name "*.md" | wc -l)
            if [ "$doc_count" -gt 0 ]; then
              echo "✓ Found $doc_count documentation files in docs/"
            fi
          fi

  build-test:
    name: Test Docker Build
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        lab:
          - labs/lab_01_simple_app
          - concepts/01_getting_started
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Find Dockerfile
        id: dockerfile
        run: |
          if [ -f "${{ matrix.lab }}/Dockerfile" ]; then
            echo "path=${{ matrix.lab }}/Dockerfile" >> $GITHUB_OUTPUT
          else
            echo "path=$(find ${{ matrix.lab }} -name "Dockerfile*" -type f | head -1)" >> $GITHUB_OUTPUT
          fi
      
      - name: Build Docker image
        if: steps.dockerfile.outputs.path != ''
        uses: docker/build-push-action@v5
        with:
          context: ${{ github.workspace }}/${{ matrix.lab }}
          file: ${{ steps.dockerfile.outputs.path }}
          push: false

  dockerfile-lint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Dockerfile linter
        run: |
          echo "Checking Dockerfile best practices..."
          
          dockerfile_count=0
          warning_count=0
          
          find . -name "Dockerfile*" -type f | while read dockerfile; do
            dockerfile_count=$((dockerfile_count + 1))
            
            # Check for common issues (warnings, not failures)
            if grep -q "^FROM.*latest" "$dockerfile"; then
              echo "⚠ $dockerfile: Using 'latest' tag (not recommended)"
              warning_count=$((warning_count + 1))
            fi
            
            if ! grep -q "USER" "$dockerfile"; then
              echo "⚠ $dockerfile: No USER directive (running as root)"
              warning_count=$((warning_count + 1))
            fi
          done
          
          echo "✓ Dockerfile linting complete (warnings noted but not failing build)"

  security-scan:
    name: Security Vulnerability Scanning
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run security checks
        run: |
          echo "Running security checks..."
          
          # Check for hardcoded secrets (basic check)
          echo "Scanning for hardcoded secrets..."
          if grep -r "password.*=\|secret.*=\|token.*=" --include="*.py" --include="*.js" --include="*.go" . 2>/dev/null | grep -v ".git" | grep -v "node_modules"; then
            echo "⚠ Potential hardcoded secrets found (review needed)"
          else
            echo "✓ No obvious hardcoded secrets detected"
          fi
          
          # Check for .env files
          if [ -f ".env" ] || [ -f ".env.local" ]; then
            echo "⚠ Environment files detected (ensure they're in .gitignore)"
          fi
          
          echo "✓ Security scan complete"

  performance-test:
    name: Docker Build Performance Test
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Test build performance
        run: |
          echo "Running Docker build performance test..."
          
          # Test building lab_01 and measure time
          start_time=$(date +%s)
          
          cd labs/lab_01_simple_app
          docker build -t dockversehub-test:latest -f Dockerfile . > /dev/null 2>&1
          build_result=$?
          
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          
          if [ $build_result -eq 0 ]; then
            echo "✓ Build successful in ${duration}s"
            if [ $duration -gt 120 ]; then
              echo "⚠ Build took longer than 2 minutes (${duration}s)"
            fi
          else
            echo "⚠ Build test failed (continuing anyway)"
          fi
          
          cd - > /dev/null

  report:
    name: Build Status Report
    runs-on: ubuntu-latest
    needs: [validate-syntax, validate-configuration, verify-labs, verify-concepts, check-documentation, build-test]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## DockVerseHub CI/CD Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** All critical checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Critical Checks:" >> $GITHUB_STEP_SUMMARY
          echo "- Syntax Validation: ${{ needs.validate-syntax.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration Validation: ${{ needs.validate-configuration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lab Verification: ${{ needs.verify-labs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Concept Verification: ${{ needs.verify-concepts.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation Check: ${{ needs.check-documentation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Test: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: Check overall status
        run: |
          # Only fail if critical checks fail
          critical_failed=false
          
          if [ "${{ needs.validate-syntax.result }}" == "failure" ]; then
            critical_failed=true
          fi
          
          if [ "${{ needs.validate-configuration.result }}" == "failure" ]; then
            critical_failed=true
          fi
          
          if [ "${{ needs.verify-labs.result }}" == "failure" ]; then
            critical_failed=true
          fi
          
          if [ "${{ needs.verify-concepts.result }}" == "failure" ]; then
            critical_failed=true
          fi
          
          if [ "${{ needs.check-documentation.result }}" == "failure" ]; then
            critical_failed=true
          fi
          
          if [ "$critical_failed" == "true" ]; then
            echo "❌ Critical checks failed"
            exit 1
          fi
          
          echo "✓ All critical checks passed!"
